name: Nightly Build

on:
  # æ”¯æŒ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ”¯æŒ PR è¯„è®ºè§¦å‘
  issue_comment:
    types: [created]

env:
  NODE_VERSION: 22.x
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NIGHTLY_TAG: nightly
  ALLOWED_USER: roitium

jobs:
  check-trigger:
    permissions:
      issues: write
      contents: read
      pull-requests: write
    # æ‰‹åŠ¨è§¦å‘æ—¶ç›´æ¥é€šè¿‡ï¼ŒPR è¯„è®ºè§¦å‘æ—¶éœ€è¦æ£€æŸ¥æ¡ä»¶
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       github.event.comment.body == '/build-nightly')
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      pr_number: ${{ steps.context.outputs.pr_number }}
      head_sha: ${{ steps.context.outputs.head_sha }}
      trigger_type: ${{ steps.context.outputs.trigger_type }}
    steps:
      - name: ğŸ” Check user permission
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘ï¼Œç›´æ¥å…è®¸
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger by ${{ github.actor }}"
          elif [[ "${{ github.event.comment.user.login }}" == "${{ env.ALLOWED_USER }}" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… User ${{ github.event.comment.user.login }} is allowed to trigger nightly build"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "âŒ User ${{ github.event.comment.user.login }} is not allowed to trigger nightly build"
          fi

      - name: ğŸ“ React to comment
        if: github.event_name == 'issue_comment' && steps.check.outputs.should_build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: ğŸ” Determine build context
        if: steps.check.outputs.should_build == 'true'
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–é»˜è®¤åˆ†æ”¯çš„æœ€æ–° commit
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch;

            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${defaultBranch}`
            });

            core.setOutput('head_sha', ref.data.object.sha);

            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('pr_number', '');
              core.setOutput('trigger_type', 'manual');
            } else {
              core.setOutput('pr_number', context.issue.number);
              core.setOutput('trigger_type', 'pr_comment');
            }

  build:
    needs: check-trigger
    concurrency:
      group: nightly-build
      cancel-in-progress: true
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    permissions:
      contents: write
      pull-requests: write
      packages: read
    env:
      ABI_FILTERS: arm64-v8a

    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.head_sha }}
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ä»¥è®¡ç®— commit æ•°é‡

      - name: ğŸ¤– Setup PNPM
        uses: pnpm/action-setup@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}
          packager: pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: âš™ï¸ Prepare Variables
        run: |
          APP_VERSION=$(node -p "require('./apps/mobile/package.json').version")
          COMMIT_SHA="${{ needs.check-trigger.outputs.head_sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          VERSION_CODE=$(git rev-list --count HEAD)

          APK_NAME="bbplayer-nightly-${SHORT_SHA}"

          echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV
          echo "APK_PATH=${{ runner.temp }}/${APK_NAME}.apk" >> $GITHUB_ENV
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV

          echo "ğŸ“Š Calculated VERSION_CODE: ${VERSION_CODE}"

      - name: ğŸš€ Build APK
        run: cd apps/mobile && eas build --platform android --profile prod-v8a --local --no-wait --output=${{ env.APK_PATH }}
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.APK_NAME }}
          path: ${{ env.APK_PATH }}
          if-no-files-found: error

      - name: ğŸ·ï¸ Update Nightly Release
        run: |
          RELEASE_NOTES="## ğŸŒ™ Nightly Build

          **âš ï¸ è­¦å‘Šï¼šè¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸ç¨³å®š**

          ---

          | ä¿¡æ¯ | å€¼ |
          |------|-----|
          | ğŸ“ Commit | [\`${{ env.SHORT_SHA }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ env.COMMIT_SHA }}) |
          | ğŸ• æ„å»ºæ—¶é—´ | ${{ env.TIMESTAMP }} UTC |
          | ğŸ“¦ æ¶æ„ | arm64-v8a |"

          # æ£€æŸ¥ nightly release æ˜¯å¦å­˜åœ¨
          if gh release view ${{ env.NIGHTLY_TAG }} > /dev/null 2>&1; then
            echo "Nightly release exists, updating..."
            
            # åˆ é™¤æ‰€æœ‰æ—§çš„ APK é™„ä»¶
            gh release view ${{ env.NIGHTLY_TAG }} --json assets -q '.assets[].name' | while read asset; do
              if [[ "$asset" == *.apk ]]; then
                echo "Deleting old asset: $asset"
                gh release delete-asset ${{ env.NIGHTLY_TAG }} "$asset" --yes || true
              fi
            done
            
            # ä¸Šä¼ æ–°çš„ APK
            gh release upload ${{ env.NIGHTLY_TAG }} "${{ env.APK_PATH }}" --clobber
            
            # æ›´æ–° release notes
            gh release edit ${{ env.NIGHTLY_TAG }} \
              --title "Nightly Build" \
              --notes "$RELEASE_NOTES"
          else
            echo "Creating new nightly release..."
            gh release create ${{ env.NIGHTLY_TAG }} \
              "${{ env.APK_PATH }}" \
              --title "Nightly Build" \
              --prerelease \
              --notes "$RELEASE_NOTES"
          fi

      - name: ğŸ”„ Update Nightly Tag
        run: |
          # å¼ºåˆ¶æ›´æ–° nightly tag æŒ‡å‘å½“å‰æ„å»ºçš„ commit
          git tag -f ${{ env.NIGHTLY_TAG }} ${{ env.COMMIT_SHA }}
          git push -f origin ${{ env.NIGHTLY_TAG }}

  notify:
    needs: [check-trigger, build]
    # åªåœ¨ PR è¯„è®ºè§¦å‘æ—¶å‘é€é€šçŸ¥
    if: always() && needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.trigger_type == 'pr_comment'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ’¬ Send build notification
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = "${{ needs.build.result }}";
            const prNumber = ${{ needs.check-trigger.outputs.pr_number }};
            const headSha = "${{ needs.check-trigger.outputs.head_sha }}";
            const shortSha = headSha.substring(0, 7);
            const runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}";
            const releaseUrl = "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.NIGHTLY_TAG }}";

            let body;
            if (buildResult === 'success') {
              body = `## âœ… Nightly æ„å»ºæˆåŠŸ

            | ä¿¡æ¯ | å€¼ |
            |------|-----|
            | ğŸ“ Commit | \`${shortSha}\` |
            | ğŸ“¦ ä¸‹è½½ | [Nightly Release](${releaseUrl}) |
            | ğŸ”— è¯¦æƒ… | [Workflow](${runUrl}) |

            APK å·²ä¸Šä¼ åˆ° [Nightly Release](${releaseUrl}) ğŸš€`;
            } else if (buildResult === 'cancelled') {
              body = `## â¹ï¸ Nightly æ„å»ºå·²å–æ¶ˆ

            æ„å»ºè¢«æ–°çš„ \`/build-nightly\` è¯·æ±‚å–æ¶ˆã€‚

            - **Commit:** \`${shortSha}\`
            - **è¯¦æƒ…:** [Workflow](${runUrl})`;
            } else {
              body = `## âŒ Nightly æ„å»ºå¤±è´¥

            - **Commit:** \`${shortSha}\`
            - **è¯¦æƒ…:** [Workflow](${runUrl})

            è¯·æŸ¥çœ‹ workflow æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
