name: Test Version Code

on:
  workflow_dispatch:

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Setup repo (full history)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ËÆ∞ÂΩï

      - name: üìä Step 1 - Test git commit count immediately after checkout
        run: |
          echo "=== Git Status After Checkout ==="
          echo "Git commit count: $(git rev-list --count HEAD)"
          echo "Total commits available: $(git log --oneline | wc -l)"
          echo "Latest 5 commits:"
          git log --oneline -5
          echo ""

      - name: ü§ñ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üèó Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: üèó Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}
          packager: pnpm

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üìä Step 2 - Test git in Node.js context
        run: |
          echo "=== Testing git command in Node.js ==="
          node -e "
            const { execSync } = require('child_process');
            try {
              const commitCount = execSync('git rev-list --count HEAD', { encoding: 'utf-8' }).trim();
              console.log('‚úÖ Version code from Node.js:', commitCount);
            } catch (error) {
              console.error('‚ùå Error:', error.message);
            }
          "

      - name: üìä Step 3 - Test expo config (this runs app.config.ts)
        run: |
          echo "=== Testing expo config ==="
          npx expo config --type public 2>&1 | tee expo-config-output.txt
          echo ""
          echo "=== Extracted versionCode ==="
          grep -E '"versionCode"' expo-config-output.txt || echo "versionCode not found in output"

      - name: üìä Step 4 - Check what files EAS will upload
        run: |
          echo "=== Checking EAS archive behavior ==="
          echo ".git directory exists: $([ -d .git ] && echo 'YES' || echo 'NO')"
          echo ".git directory size: $(du -sh .git 2>/dev/null || echo 'N/A')"
          echo ""
          echo "=== Checking .gitignore and .easignore ==="
          echo "--- .gitignore content (first 20 lines) ---"
          head -20 .gitignore 2>/dev/null || echo "No .gitignore"
          echo ""
          echo "--- .easignore content ---"
          cat .easignore 2>/dev/null || echo "No .easignore file"
          echo ""
          echo "=== KEY FINDING ==="
          echo "EAS local build will archive and extract the project."
          echo "The .git directory is typically EXCLUDED from this archive!"
          echo "This means git commands will FAIL during the actual Gradle build."

      - name: üìä Step 5 - Simulate EAS archive behavior
        run: |
          echo "=== Simulating what happens during EAS build ==="
          mkdir -p /tmp/eas-test

          # Archive without .git (simulating EAS behavior)
          tar --exclude='.git' --exclude='node_modules' -czf /tmp/eas-test/project.tar.gz .

          # Extract to temp dir
          mkdir -p /tmp/eas-test/extracted
          cd /tmp/eas-test/extracted
          tar -xzf ../project.tar.gz

          echo "Extracted project directory contents:"
          ls -la

          echo ""
          echo ".git directory exists in extracted project: $([ -d .git ] && echo 'YES' || echo 'NO')"

          echo ""
          echo "Testing git command in extracted project:"
          git rev-list --count HEAD 2>&1 && echo "Git works!" || echo "‚ùå Git command FAILED (as expected)"

          echo ""
          echo "Testing app.config.ts in extracted project:"
          cd /tmp/eas-test/extracted
          npm install 2>/dev/null || true
          node -e "
            const { execSync } = require('child_process');
            try {
              const commitCount = execSync('git rev-list --count HEAD', { encoding: 'utf-8' }).trim();
              console.log('Version code:', commitCount);
            } catch (error) {
              console.log('‚ùå FAILED: This is why versionCode becomes 1!');
              console.log('Error:', error.message);
            }
          "

      - name: üìù Summary
        run: |
          echo ""
          echo "============================================="
          echo "              DIAGNOSIS SUMMARY              "
          echo "============================================="
          echo ""
          echo "The issue is that EAS Local Build does NOT include"
          echo "the .git directory when archiving the project."
          echo ""
          echo "This means during the actual build process:"
          echo "  1. Project is archived (without .git)"
          echo "  2. Gradle runs prebuild which executes app.config.ts"
          echo "  3. app.config.ts calls 'git rev-list --count HEAD'"
          echo "  4. Git command fails because there's no .git directory"
          echo "  5. versionCode falls back to 1 or the build fails"
          echo ""
          echo "SOLUTION OPTIONS:"
          echo "  1. Pass versionCode as an environment variable to EAS"
          echo "  2. Write versionCode to a file before EAS build"
          echo "  3. Use EAS's built-in versionCode management"
          echo ""
