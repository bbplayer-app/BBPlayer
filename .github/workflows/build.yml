name: Build and Release

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - preview
          - blank-test

  pull_request:
    types: [closed]
    branches:
      - master

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  MENTION_USER: '@roitium'

jobs:
  setup:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      buildType: ${{ steps.set-vars.outputs.buildType }}
      profile: ${{ steps.set-matrix.outputs.profile }}
      commitSha: ${{ steps.set-vars.outputs.commitSha }}
      prNumber: ${{ steps.set-vars.outputs.prNumber }}
    steps:
      - name: Determine Variables
        id: set-vars
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "buildType=prod" >> $GITHUB_OUTPUT
            echo "commitSha=${{ github.event.pull_request.merge_commit_sha }}" >> $GITHUB_OUTPUT
            echo "prNumber=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "buildType=${{ github.event.inputs.buildType }}" >> $GITHUB_OUTPUT
            echo "commitSha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "prNumber=" >> $GITHUB_OUTPUT
          fi

      - name: Determine Matrix and Profile
        id: set-matrix
        run: |
          BUILD_TYPE="${{ steps.set-vars.outputs.buildType }}"

          if [[ "$BUILD_TYPE" == "prod" ]]; then
            echo "matrix={\"include\":[{\"arch\":\"arm64-v8a\"},{\"arch\":\"armeabi-v7a\"},{\"arch\":\"x86_64\"},{\"arch\":\"x86\"}]}" >> $GITHUB_OUTPUT
            echo "profile=prod-ci" >> $GITHUB_OUTPUT
          elif [[ "$BUILD_TYPE" == "blank-test" ]]; then
             echo "matrix={\"include\":[{\"arch\":\"arm64-v8a\"}]}" >> $GITHUB_OUTPUT
             echo "profile=blank-test" >> $GITHUB_OUTPUT
          else
            # dev, preview - default to arm64-v8a
            echo "matrix={\"include\":[{\"arch\":\"arm64-v8a\"}]}" >> $GITHUB_OUTPUT
            echo "profile=$BUILD_TYPE" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: blacksmith-2vcpu-ubuntu-2404
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    permissions:
      contents: write
      pull-requests: write
      packages: read
    env:
      BUILD_TYPE: ${{ needs.setup.outputs.buildType }}
      EAS_PROFILE: ${{ needs.setup.outputs.profile }}
      ABI_FILTERS: ${{ matrix.arch }}

    environment: ${{ (github.event_name == 'pull_request' && 'production') || null }}

    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.setup.outputs.commitSha }}
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ä»¥è®¡ç®— commit æ•°é‡

      - name: ğŸ¤– Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}
          packager: pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: âš™ï¸ Prepare Variables
        run: |
          APP_VERSION=$(node -p "require('./package.json').version")

          # e.g. bbplayer-v1.0.0-prod-arm64-v8a
          APK_NAME="bbplayer-v${APP_VERSION}-${{ env.BUILD_TYPE }}-${{ matrix.arch }}"

          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV
          echo "APK_TEMP_PATH=${{runner.temp}}/${APK_NAME}.apk" >> $GITHUB_ENV

      - name: ğŸš€ Build APK
        if: env.BUILD_TYPE != 'blank-test'
        run: eas build --platform android --profile ${{ env.EAS_PROFILE }} --local --no-wait --output=${{ env.APK_TEMP_PATH }}

      - name: ğŸ§ª Create Dummy APK
        if: env.BUILD_TYPE == 'blank-test'
        run: |
          echo "Dummy APK ${{ env.APK_NAME }}" > ${{ env.APK_TEMP_PATH }}

      - name: ğŸš€ Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.APK_NAME }}
          path: ${{ env.APK_TEMP_PATH }}
          if-no-files-found: error

  release:
    needs: [setup, build]
    if: needs.setup.outputs.buildType == 'prod' || needs.setup.outputs.buildType == 'blank-test'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.setup.outputs.commitSha }}

      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: âš™ï¸ Prepare Release Variables
        run: |
          APP_VERSION=$(node -p "require('./package.json').version")
          echo "RELEASE_TAG=v${APP_VERSION}" >> $GITHUB_ENV
          ls -R dist/

      - name: ğŸ Create Release
        run: |
          FILES=$(find dist -name "*.apk" -type f) 

          gh release create ${{ env.RELEASE_TAG }} \
            $FILES \
            --title "${{ env.RELEASE_TAG }}" \
            --draft \
            --notes "auto release by GitHub Actions"

  notify:
    needs: [setup, build]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¬ Send build status notification
        uses: actions/github-script@v8
        with:
          script: |
            const buildResult = "${{ needs.build.result }}";
            const buildType = "${{ needs.setup.outputs.buildType }}";
            const commitSha = "${{ needs.setup.outputs.commitSha }}";
            const prNumber = "${{ needs.setup.outputs.prNumber }}";
            const runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}";
            const mention = "${{ env.MENTION_USER }}";

            const icon = buildResult == 'success' ? 'âœ…' : 'âŒ';
            const title = buildResult == 'success' ? `æ„å»ºè½¯ä»¶åŒ…æˆåŠŸ` : `æ„å»ºè½¯ä»¶åŒ…å¤±è´¥`;

            let body = `
            ## ${icon} ${title} (${buildType})

            ${mention}, æ–°ç‰ˆè§¦å‘çš„æ„å»ºå·²ç»å®Œæˆ

            - **çŠ¶æ€:** ${buildResult}
            - **æäº¤:** 
            ${commitSha.substring(0, 7)}
            - **è¯¦ç»†ä¿¡æ¯:** [Workflow](${runUrl})
            `;

            if (prNumber) {
              body += `\n- **è§¦å‘äº‹ä»¶:** PR #${prNumber}`;
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: body
                });
              } catch (e) {
                console.error(`Failed to comment on PR: ${e.message}.`);
              }
            }
