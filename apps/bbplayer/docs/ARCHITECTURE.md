# é¡¹ç›®æ¶æ„æŒ‡å—

BBPlayer æ˜¯ä¸€ä¸ªåŸºäº **React Native (Expo)** çš„ç°ä»£åŒ–ç§»åŠ¨ç«¯åº”ç”¨ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€ç›®å½•ç»“æ„ä»¥åŠæ ¸å¿ƒå¼€å‘æ¨¡å¼ã€‚

## ğŸ›  æŠ€æœ¯æ ˆæ¦‚è§ˆ

- **æ ¸å¿ƒæ¡†æ¶**: [Expo](https://expo.dev), [React Native](https://reactnative.dev)
- **è·¯ç”±å¯¼èˆª**: [Expo Router](https://docs.expo.dev/router/introduction/) (æ–‡ä»¶ç³»ç»Ÿè·¯ç”±)
- **çŠ¶æ€ç®¡ç†**:
  - [Zustand](https://github.com/pmndrs/zustand) (å…¨å±€å®¢æˆ·ç«¯çŠ¶æ€)
  - [TanStack Query](https://tanstack.com/query/latest) (æœåŠ¡ç«¯/å¼‚æ­¥çŠ¶æ€ç®¡ç†)
- **æ•°æ®åº“**: [Drizzle ORM](https://orm.drizzle.team/) + `expo-sqlite`
- **UI ç»„ä»¶**: [React Native Paper](https://reactnativepaper.com/) + è‡ªå®šä¹‰ç»„ä»¶
- **é”™è¯¯å¤„ç†**: [neverthrow](https://github.com/supermacro/neverthrow) (å‡½æ•°å¼é”™è¯¯å¤„ç†)

## ğŸ— ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ app/                 # Expo Router è·¯ç”±å®šä¹‰ (Pages)
â”œâ”€â”€ components/          # é€šç”¨ UI ç»„ä»¶
â”œâ”€â”€ features/            # åŠŸèƒ½æ¨¡å— (æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†)
â”‚   â”œâ”€â”€ player/
â”‚   â”œâ”€â”€ playlist/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/               # å…¨å±€é€šç”¨ Hooks
â”œâ”€â”€ lib/                 # æ ¸å¿ƒé€»è¾‘ä¸åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ api/             # å¤–éƒ¨ API é›†æˆ (å¦‚ Bilibili)
â”‚   â”œâ”€â”€ config/          # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ db/              # Drizzle æ•°æ®åº“ Schema ä¸é…ç½®
â”‚   â”œâ”€â”€ facades/         # [æ¶æ„æ ¸å¿ƒ] Facade å±‚
â”‚   â””â”€â”€ services/        # [æ¶æ„æ ¸å¿ƒ] Service å±‚
â”œâ”€â”€ types/               # TypeScript ç±»å‹å®šä¹‰
â””â”€â”€ utils/               # å·¥å…·å‡½æ•°

æ³¨ï¼šä»¥ä¸Šæ˜¯ `apps/bbplayer` å†…çš„æºç ç»“æ„ã€‚åœ¨ Monorepo æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬è¿˜æœ‰ `packages/` ç›®å½•ç”¨äºå­˜æ”¾å…±äº«åŒ…ï¼Œä¾‹å¦‚ï¼š
- `@roitium/expo-orpheus`: æ’­æ”¾å™¨æ ¸å¿ƒé€»è¾‘
- `@roitium/expo-image-theme-colors`: å›¾ç‰‡ä¸»é¢˜è‰²æå–
- `@roitium/react-native-logs`: æ—¥å¿—å·¥å…·åº“
```

## ğŸ§© æ ¸å¿ƒæ¶æ„æ¨¡å¼

æœ¬é¡¹ç›®é‡‡ç”¨äº† **åˆ†å±‚æ¶æ„ (Layered Architecture)** ä¸ **åŠŸèƒ½åˆ‡ç‰‡ (Feature Slices)** ç›¸ç»“åˆçš„æ¨¡å¼ã€‚

### 1. åˆ†å±‚æ¶æ„ (Layered Architecture)

ä¸ºäº†åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œæˆ‘ä»¬å°†ä¸šåŠ¡é€»è¾‘åˆ†ä¸ºä»¥ä¸‹å‡ å±‚ï¼š

#### **UI Layer (Components & Hooks)**

- **ä½ç½®**: `src/app`, `src/features/*/components`, `src/features/*/hooks`
- **èŒè´£**: å¤„ç†è§†å›¾å±•ç¤ºã€ç”¨æˆ·äº¤äº’ã€‚
- **åŸåˆ™**: å°½é‡å°‘åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œä¸»è¦é€šè¿‡è°ƒç”¨ Hooks æˆ– Facades æ¥è·å–æ•°æ®å’Œæ‰§è¡Œæ“ä½œã€‚

#### **Facade Layer (å¤–è§‚æ¨¡å¼)**

- **ä½ç½®**: `src/lib/facades`
- **èŒè´£**:
  - ä½œä¸º UI å±‚ä¸åº•å±‚é€»è¾‘çš„**ç»Ÿä¸€å…¥å£**ã€‚
  - **ç¼–æ’**å¤šä¸ª Service çš„è°ƒç”¨ã€‚
  - ç®¡ç†**æ•°æ®åº“äº‹åŠ¡ (Transactions)**ï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚
- **ç¤ºä¾‹**: `PlaylistFacade` å¯èƒ½åŒæ—¶è°ƒç”¨ `PlaylistService` (åˆ›å»ºæ­Œå•) å’Œ `TrackService` (æ·»åŠ æ­Œæ›²)ã€‚

#### **Service Layer (é¢†åŸŸæœåŠ¡)**

- **ä½ç½®**: `src/lib/services`
- **èŒè´£**:
  - å¤„ç†å•ä¸€é¢†åŸŸçš„**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ã€‚
  - ç›´æ¥ä¸æ•°æ®åº“ (Drizzle) äº¤äº’ã€‚
  - ä¸å…³å¿ƒ UIï¼Œä¹Ÿä¸å…³å¿ƒäº‹åŠ¡çš„å¼€å¯ï¼ˆé€šå¸¸ç”± Facade ç®¡ç†ï¼Œæˆ–è€…åœ¨ Service å†…éƒ¨å¤„ç†ç®€å•æŸ¥è¯¢ï¼‰ã€‚
- **ç¤ºä¾‹**: `PlaylistService` åªè´Ÿè´£å¯¹ `playlist` è¡¨çš„å¢åˆ æ”¹æŸ¥ã€‚

#### **Infrastructure / Data Layer**

- **ä½ç½®**: `src/lib/api`, `src/lib/db`
- **èŒè´£**: å¤„ç†å¤–éƒ¨ API è¯·æ±‚å’Œåº•å±‚æ•°æ®åº“è¿æ¥ã€‚

### 2. é”™è¯¯å¤„ç† (Error Handling)

æœ¬é¡¹ç›®**ä¸¥ç¦**åœ¨ä¸šåŠ¡é€»è¾‘ä¸­éšæ„æŠ›å‡ºå¼‚å¸¸ (Throwing Errors)ã€‚æˆ‘ä»¬ä½¿ç”¨ `neverthrow` åº“é‡‡ç”¨ **Result æ¨¡å¼** è¿›è¡Œé”™è¯¯å¤„ç†ã€‚

- **åŸåˆ™**: å‡½æ•°åº”è¿”å› `Result<T, E>` æˆ– `ResultAsync<T, E>`ã€‚
- **ä¼˜åŠ¿**: å¼ºåˆ¶è°ƒç”¨æ–¹å¤„ç†é”™è¯¯ï¼Œç±»å‹å®‰å…¨ï¼Œé¿å…éšå¼å´©æºƒã€‚

## ğŸ’¾ æ•°æ®ä¸æ’­æ”¾å™¨è®¾è®¡è¯´æ˜

### æ’­æ”¾å™¨æ•°æ®çº¦æŸ

- **åŸåˆ™**: ä¼ é€’ç»™ Player çš„ Track `uniqueKey` **å¿…é¡»**åœ¨æœ¬åœ°æ•°æ®åº“ä¸­æœ‰è®°å½•ã€‚
- **åŸå› **: `currentTrack` hook ä¾èµ– `uniqueKey` æ¥æŸ¥è¯¢å’Œå…³è”æ•°æ®åº“ä¸­çš„æ‰©å±•å…ƒæ•°æ®ã€‚

### åˆ† P è§†é¢‘å¤„ç† (Bilibili)

ç›®å‰é¡¹ç›®ä¸­å­˜åœ¨ä¸¤ç§è§†é¢‘å…¥å£ï¼š

1. **æ•´è§†é¢‘** (`isMultiPage = false`)
2. **åˆ† P è§†é¢‘** (`isMultiPage = true`, å·²çŸ¥ `cid`)

**éš¾ç‚¹**: å¯¼å…¥æ—¶éš¾ä»¥æ ‡å‡†åŒ–ä¸ºåŒä¸€é”®å€¼ï¼ˆè·å– `cid` æˆæœ¬é«˜ï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®åº“ä¸­å­˜åœ¨é€»è¾‘ä¸Šé‡å¤çš„è®°å½•ã€‚ç›®å‰çš„ç­–ç•¥æ˜¯å°½é‡ä¿æŒç°çŠ¶ï¼Œåç»­åœ¨ `TECHNICAL_DEBT.md` ä¸­æœ‰è¯¦ç»†è®°å½•ã€‚
